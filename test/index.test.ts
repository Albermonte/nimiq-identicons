import { Buffer } from 'node:buffer'
import { consola } from 'consola'
import { describe, expect, it, vi } from 'vitest'
import { createIdenticon } from '../src'
import { optimizeSvg } from '../src/optimizer'

function showDifference(originalSvg: string, newSvg: string): void {
  // Show the difference in size between the original and the new SVG
  const originalSize = Buffer.byteLength(originalSvg, 'utf-8')
  const newSize = Buffer.byteLength(newSvg, 'utf-8')
  const difference = newSize - originalSize

  consola.info(`Original size: ${originalSize} bytes. New size: ${newSize} bytes. Difference: ${difference} bytes.`)
}

describe('should create the identicon', () => {
  it('exported', async () => {
    // Spy on Math.random and make it return 0.5546875 (142/256)
    const randomSpy = vi.spyOn(Math, 'random').mockReturnValue(142 / 256)

    const originalSvg = `<svg viewBox="0 0 160 160" width="160" height="160" ><defs><clipPath id="hexagon-clip-142"><path d="M251.6 17.34l63.53 110.03c5.72 9.9 5.72 22.1 0 32L251.6 269.4c-5.7 9.9-16.27 16-27.7 16H96.83c-11.43 0-22-6.1-27.7-16L5.6 159.37c-5.7-9.9-5.7-22.1 0-32L69.14 17.34c5.72-9.9 16.28-16 27.7-16H223.9c11.43 0 22 6.1 27.7 16z" transform="scale(0.5) translate(0, 16)"></path></clipPath></defs><g clip-path="url(#hexagon-clip-142)"><g color="#E9B213" fill="#5961A8"><rect fill="#88B04B" x="0" y="0" width="160" height="160"></rect><circle cx="80" cy="80" r="40" fill="#E9B213"></circle><g opacity=".1" fill="#010101"><path d="M119.21,80a39.46,39.46,0,0,1-67.13,28.13c10.36,2.33,36,3,49.82-14.28,10.39-12.47,8.31-33.23,4.16-43.26A39.35,39.35,0,0,1,119.21,80Z"></path></g><path  d="M44.6 62C55.1 45 63.9 28.7 67 15c3.8-1.3 24.3 18 42 38.5 0 0-29.1-31.9-64.4 8.5z" fill="currentColor"></path><path  d="M68 15c8.4 4.8 25.2 22.5 41 38.5-9.9-8.7-17.9-12.4-24.7-12.8L68 15z" fill="#010101" opacity=".1"></path><path  d="M113.7 37.9s11 5 10 12-10 5-10-1-3-10 0-11zM115.2 33.8s4.2-1.4 5.7.7c1.5 2-1.4 3.8-2.9 2.2-1.5-1.6-3.3-2-2.8-3zM48.8 25.5s-10 4.5-9.1 10.9 9.1 4.5 9.1-.9 2.7-9.1 0-10zM33.5 46.8s.7 5.6-2.4 6.9-4.4-2.8-2-4.2 3.3-3.6 4.4-2.7z"></path><path  d="M125.8 71.4s19.2 1.4 19.6 2.8c.1.4-18.2 9.7-17 9.1 0 0 2.4-5.8 2.1-7.1s-4.7-4.8-4.7-4.8z" fill="#5e5e5e"></path><path  d="M125.2 71.3s19.2 1.4 19.6 2.8c-5 1-14.6 2.4-14.6 2.4l-5-5.2z" fill="#e2e2e2"></path><g  fill="#603813"><path d="M130.6 79.2l-11.6 1v-4.7l10.8-.8s5 .4 5.2 1.2-2.7 3-4.4 3.3zM54.6 83.7l-36.5 2s-2.8.1-3-1.6c-.1-1.5.8-2.4 2.6-2.9L54 77.5a3.2 3.2 0 013.4 2.8 3 3 0 01-2.8 3.4z"></path></g><path  d="M54.6 83.7l-36.5 2c-1.8 0-2.8-.5-3-1.6 17-1.2 44.2-2.4 42.3-3.8 0 .1.5 2.7-2.8 3.4z" opacity=".2"></path><path  d="M38.8 80.4l-5.4-5.8-17.1.1 6.1 6.6zM39.4 83.2l-6.6 7.9-17.1 1.2 6.6-7.9z"></path><g  fill="#010101" opacity=".2"><path d="M23.8 76.7c.2-.2.5-.2.7 0l2.7 2.9c.2.2.2.5 0 .7-.2.2-.5.2-.7 0l-2.7-2.9a.5.5 0 010-.7zM20.8 76.7c.2-.2.5-.2.7 0l2.7 2.9c.2.2.2.5 0 .7-.2.2-.5.2-.7 0l-2.7-2.9a.5.5 0 010-.7zM26.8 76.7c.2-.2.5-.2.7 0l2.7 2.9c.2.2.2.5 0 .7-.2.2-.5.2-.7 0l-2.7-2.9a.5.5 0 010-.7zM29.8 76.7c.2-.2.5-.2.7 0l2.7 2.9c.2.2.2.5 0 .7-.2.2-.5.2-.7 0l-2.7-2.9a.5.5 0 010-.7zM32.8 76.7c.2-.2.5-.2.7 0l2.7 2.9c.2.2.2.5 0 .7-.2.2-.5.2-.7 0l-2.7-2.9a.5.5 0 010-.7zM26.2 85.7c.2.2.2.5 0 .7l-2.7 2.9c-.2.2-.5.2-.7 0a.5.5 0 010-.7l2.7-2.9c.2-.2.5-.2.7 0zM23.2 85.7c.2.2.2.5 0 .7l-2.7 2.9c-.2.2-.5.2-.7 0a.5.5 0 010-.7l2.7-2.9c.2-.2.5-.2.7 0zM29.2 85.7c.2.2.2.5 0 .7l-2.7 2.9c-.2.2-.5.2-.7 0a.5.5 0 010-.7l2.7-2.9c.2-.2.5-.2.7 0zM32.2 85.7c.2.2.2.5 0 .7l-2.7 2.9c-.2.2-.5.2-.7 0a.5.5 0 010-.7l2.7-2.9c.2-.2.5-.2.7 0zM35.2 85.7c.2.2.2.5 0 .7l-2.7 2.9c-.2.2-.5.2-.7 0a.5.5 0 010-.7l2.7-2.9c.2-.2.5-.2.7 0z"></path></g><path  d="M94 71c-7.4.5-8.9 4.8-8.9 4.8a21 21 0 00-2.4 9.2c0 4.3-.8 4 4.5 5.2 0 0-1 11 9.3 10.3v3.7c0 10.6 6.4 3.4 6.4 3.4s7.9-3.9 9.9-16.4S102.9 71 94 71zm.1 21.2l-.3-.2.3.2zm-.3-.1l-2.6-.9c.9.2 1.8.5 2.6.9zm.8.4c1.2.8 1.7 1.9 1.9 3.8a6 6 0 00-1.9-3.8z" opacity=".2"></path><ellipse  transform="rotate(-14.7 106.9 72.3)" cx="106.8" cy="72.3" rx="3.6" ry="5.1" fill="#42210b"></ellipse><ellipse  transform="rotate(-81.6 83.7 72.4)" cx="83.7" cy="72.4" rx="5.7" ry="4" fill="#42210b"></ellipse><path  d="M94.9 72c-6.7.4-8 4.4-8 4.4a19.1 19.1 0 00-2.2 8.4c0 3.9-.7 3.7 4.1 4.8 0 0-.9 10.1 8.4 9.6v3.4c0 9.8 5.8 3.1 5.8 3.1s7.1-3.6 8.9-15.1-9-18.6-17-18.6zm.1 19.6l-.3-.2.3.2zm-.3-.1l-2.3-.8c.8.1 1.6.4 2.3.8zm.7.4c1.1.8 1.5 1.8 1.7 3.5a5.1 5.1 0 00-1.7-3.5z" fill="#fbdb31"></path><path  d="M88.8 89.7s-.9 10.1 8.4 9.6c0 0 .8-6.5-2.4-7.8s-6-2-6-1.8z" opacity=".2"></path><path  d="M86.9 76.4s1.3-4 8-4.4c8 0 18.7 7.1 16.9 18.7s-8.9 15.1-8.9 15.1c8.9-16 5.2-30.5-16-29.4z" opacity=".05"></path><path  d="M90.3 79.1c-.7 1.4-1.2 2.9-1.6 4.4 0 .9 3.2-5.3 1.6-4.4zm1.3 0a14 14 0 00-.9 2.9c.1.5 2.2-3.7.9-2.9z"></path><path  d="M97 122.5s-2.8 5.5-5.5 7.5c-1.2.8-2.3 1.8-3.4 2.7v4.4c0 .4 10.2-3 8.9-14.6z" fill="#6d4716"></path><path  d="M97.6 122.5s-5.4-1.4-8.9 2-3.4 8.2-1.4 8.2 2.2.7 10.3-10.2z" fill="#fff"></path><path  d="M123.5 106.8s-4.8-8.2-19.1-.7c-14.3 7.5-2.7 23.2-15.7 30.7 0 0 3.4 4.3 8.4-5.9 4.7-9.3 4.6-24.7 26.4-24.1z" fill="#99671d"></path><path  d="M88.8 136.8s6.1 2.7 10.2-10.9 8.9-21.8 20.4-21.1c1.6 0 3.2.6 4.4 1.7 5.6 5 1.3 19.6-4.4 24.2-6.8 5.4-21.8 10.9-27.9 8.9s-2.7-2.8-2.7-2.8z" fill="#444"></path><path  d="M87.8 117.2l1 7.4c1.9-1.4 3.6-2.3 5-2.3l-.6-6.2c-1.8.5-3.6.8-5.4 1.1z" fill="currentColor"></path><path  d="M122.2 110.6h-11.6c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h11.6c.3 0 .5.2.5.5v.1c0 .3-.2.5-.5.5zM123.3 113.8h-14.7c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h14.7c.3 0 .5.2.5.5v.1c0 .3-.3.5-.5.5zM123.3 116.9h-17.9c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h17.9c.3 0 .5.2.5.5v.1c0 .3-.3.5-.5.5zM122.2 120.1h-17.9c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h17.9c.3 0 .5.2.5.5v.1c0 .2-.2.5-.5.5zM121.1 123.2h-17.9c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h17.9c.3 0 .5.2.5.5v.1c0 .3-.2.5-.5.5zM119.1 126.4h-17.9c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h17.9c.3 0 .5.2.5.5v.1c0 .2-.3.5-.5.5zM117 129.5h-15.8c-.3 0-.5-.2-.5-.5s.2-.5.5-.5H117c.3 0 .5.2.5.5v.1c0 .2-.3.4-.5.4zM112.8 132.7H99.1c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h13.7c.3 0 .5.2.5.5v.1c0 .2-.3.5-.5.5zM107.5 135.8H98c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h9.5c.3 0 .5.2.5.5v.1c0 .3-.2.5-.5.5z"></path><path  d="M63 123.5s-2.8 5.5-5.5 7.5c-1.2.8-2.3 1.8-3.4 2.7v4.4c0 .4 10.2-3 8.9-14.6z" fill="#6d4716"></path><path  d="M60.3 113l-2.1 11.3c1.9-1.4 2.7-.3 4.1-.3l2.2-9.2c-2-.4-2.9-1.4-4.2-1.8z" fill="currentColor"></path><path  d="M63.6 123.5s-5.5-1.4-8.9 2c-3.4 3.4-3.4 8.2-1.4 8.2s2.2.7 10.3-10.2z" fill="#fff"></path><path  d="M89.5 107.8s-4.8-8.2-19.1-.7c-14.3 7.5-2.7 23.2-15.7 30.7 0 0 3.6 4 8.4-6 4.6-9.3 4.6-24.6 26.4-24z" fill="#99671d"></path><path  d="M54.8 137.8s6.1 2.7 10.2-10.9 8.9-21.8 20.4-21.1c1.6 0 3.2.6 4.4 1.7 5.6 5 1.3 19.6-4.4 24.2-6.8 5.4-21.8 10.9-28 8.9s-2.6-2.8-2.6-2.8z" fill="#444"></path><path  d="M88.2 111.6H76.6c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h11.6c.3 0 .5.2.5.5v.1c0 .3-.2.5-.5.5zM89.3 114.8H74.5c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h14.7c.3 0 .5.2.5.5v.1c.1.3-.2.5-.4.5zM89.3 117.9H71.4c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h17.9c.3 0 .5.2.5.5v.1c0 .3-.3.5-.5.5zM88.2 121.1H70.3c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h17.9c.3 0 .5.2.5.5v.1c0 .2-.2.5-.5.5zM87.1 124.2H69.3c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h17.9c.3 0 .5.2.5.5v.1c-.1.3-.3.5-.6.5zM85.1 127.4H67.2c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h17.9c.3 0 .5.2.5.5v.1c0 .2-.3.5-.5.5zM83 130.5H67.2c-.3 0-.5-.2-.5-.5s.2-.5.5-.5H83c.3 0 .5.2.5.5v.1c0 .2-.3.4-.5.4zM78.8 133.7H65.1c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h13.7c.3 0 .5.2.5.5v.1c0 .2-.3.5-.5.5zM73.5 136.8H64c-.3 0-.5-.2-.5-.5v-.1c0-.3.2-.5.5-.5h9.5c.3 0 .5.2.5.5v.1c0 .3-.2.5-.5.5z"></path></g></g></svg>`
    const svg = optimizeSvg(originalSvg)
    consola.info(svg)
    showDifference(originalSvg, svg)

    const identicon = await createIdenticon('nimiq')
    expect(identicon).toEqual(svg)

    // Restore the original Math.random function
    randomSpy.mockRestore()
  })
})
